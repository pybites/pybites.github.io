<!DOCTYPE html>
<html lang="en">
    <head>

        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Setting up test cases for code that manage data can be challenging but it&#39;s an important skill to reliably test your code. You might have heard of the setup and teardown methods in unittest. In...">
        <meta name="keywords" content="coverage, fixtures, pytest, pytest-cov, refactoring, testing">

        <meta property="og:site_name" content="PyBites"/>
        <meta property="og:title" content="All You Need to Know to Start Using Fixtures in Your pytest Code"/>
        <meta property="og:description" content="Setting up test cases for code that manage data can be challenging but it's an important skill to reliably test your code. You might have heard of the setup and teardown methods in unittest. In pytest you use fixtures and as you will discover in this article they are actually not that hard to set up. Fixtures have been labelled pytest's killer feature so let's explore them in this article using a practical example."/>
        <meta property="og:locale" content="en_US"/>
        <meta property="og:url" content="https://pybit.es/pytest-fixtures.html"/>
        <meta property="og:type" content="article"/>
        <meta property="article:published_time" content="2018-03-15 13:00:00+01:00"/>
        <meta property="article:modified_time" content=""/>
        <meta property="article:author" content="https://pybit.es/author/bob.html">
        <meta property="article:section" content="Testing"/>
        <meta property="article:tag" content="pytest"/>
        <meta property="article:tag" content="fixtures"/>
        <meta property="article:tag" content="testing"/>
        <meta property="article:tag" content="refactoring"/>
        <meta property="article:tag" content="pytest-cov"/>
        <meta property="article:tag" content="coverage"/>
        <meta property="og:image" content="https://pybit.es/images/featured/pb-article.png">

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@pybites" />
        <meta name="twitter:title" content="All You Need to Know to Start Using Fixtures in Your pytest Code" />
        <meta name="twitter:description" content="Setting up test cases for code that manage data can be challenging but it's an important skill to reliably test your code. You might have heard of the setup and teardown methods in unittest. In pytest you use fixtures and as you will discover in this article they are actually not that hard to set up. Fixtures have been labelled pytest's killer feature so let's explore them in this article using a practical example." />
        <meta name="twitter:image" content="https://pybit.es/images/featured/pb-article.png">

        <link rel="icon" href="https://pybit.es/favicon.ico">
        <title>All You Need to Know to Start Using Fixtures in Your pytest Code - PyBites</title>

        <!-- Stylesheets -->
        <link href="https://pybit.es/theme/css/all.min.css" rel="stylesheet">
        <link href="https://pybit.es/theme/css/style.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <link href="https://pybit.es/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="PyBites Full Atom Feed" />
        <link href="https://pybit.es/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="PyBites Full RSS Feed" />
        <link href="https://pybit.es/feeds/testing.rss.xml" type="application/rss+xml" rel="alternate" title="PyBites Categories RSS Feed" />
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

          <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5859c6a67eb6254d" async="async"></script>

        <!-- Google Analytics -->
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-89294245-1', 'auto');
          ga('send', 'pageview');
        </script>
        <!-- /Google Analytics -->



    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '767652523960315');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=767652523960315&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Facebook Pixel Code -->

    </head>

    <body>

        <!-- Header -->
    <div class="header-container gradient">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="https://pybit.es/"><img class="mr20" src="https://pybit.es/images/logo.png" alt="logo"></a>
                    </div>
                    <div class="nav pull-right">

                        <div class="dropdown">
                          <span>RESOURCES</span>
                          <div class="dropdown-content">
                                <a href="https://www.pybitespodcast.com/"
                                    target="_blank"
                                >Podcast</a>
                                <a href="/friends"
                                >Friends List</a>
                                <a href="/community"
                                >Community</a>
                                <a href="/archives"
                                >Blog Articles</a>
                                <a href="/category/challenges"
                                >Blog Code Challenges</a>
                                <a href="https://github.com/PyBites-Open-Source"
                                    target="_blank"
                                >PyBites Open Source</a>
                                <a href="https://pybitesbooks.com"
                                    target="_blank"
                                >PyBites Books</a>
                                <a href="https://www.udemy.com/course/python-flask-for-beginners/"
                                    target="_blank"
                                >Flask Intro Course</a>
                                <a href="/100days"
                                >#100DaysOfCode</a>
                                <a href="https://codechalleng.es/tips"
                                    target="_blank"
                                >Weekly Email Tips</a>
                          </div>
                        </div>

                        <div class="dropdown">
                          <span>SERVICES</span>
                          <div class="dropdown-content">
                                <a href="https://codechalleng.es"
                                    target="_blank"
                                >Platform</a>
                                <a href="https://pybit.es/tips"
                                    target="_blank"
                                >Tips Book</a>
                                <a href="https://members.pybit.es/offers/mfFWRKHG/checkout"
                                    target="_blank"
                                >Python Intro Course</a>
                                <a href="https://pybitesproductivity.com/"
                                    target="_blank"
                                >Productivity Course</a>
                                <a href="https://pybitesdevelopermindset.com"
                                    target="_blank"
                                >PyBites Developer Mindset</a>
                          </div>
                        </div>

                        <div class="dropdown">
                          <a href="https://www.buildpythonapps.com/" id="workshopButton" target="_blank">Free Training</a>
                        </div>

                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">All You Need to Know to Start Using Fixtures in Your pytest Code</h1>
                      <p class="header-date"> <a href="https://pybit.es/author/bob.html">Bob</a>, Thu 15 March 2018,  <a href="https://pybit.es/category/testing.html">Testing</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
<a href="https://pybit.es/tag/coverage.html">coverage</a>, <a href="https://pybit.es/tag/fixtures.html">fixtures</a>, <a href="https://pybit.es/tag/pytest.html">pytest</a>, <a href="https://pybit.es/tag/pytest-cov.html">pytest-cov</a>, <a href="https://pybit.es/tag/refactoring.html">refactoring</a>, <a href="https://pybit.es/tag/testing.html">testing</a>                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <p>Setting up test cases for code that manage data can be challenging but it's an important skill to reliably test your code. You might have heard of the setup and teardown methods in <code>unittest</code>. In <code>pytest</code> you use <em>fixtures</em> and as you will discover in this article they are actually not that hard to set up. Fixtures have been labelled <em>pytest's killer feature</em> so let's explore them in this article using a practical example.</p>
<blockquote>
<p>pytest fixtures ... are the reason why many people switch to and stay with pytest. ... one of the great reasons to use fixtures: to focus the test on what youâ€™re actually testing, not on what you had to do to get ready for the test. - Brian Okken's <a href="https://pybit.es/pytest-book.html">Python testing with pytest</a></p>
</blockquote>
<h2>Why do you want fixtures?</h2>
<p>If your tests need to work on data you typically need to set them up. This is often a process that has to be repeated and independent for each test. This often leads to duplicate code which is "number one in the stink parade" (<a href="https://www.safaribooksonline.com/library/view/building-maintainable-software/9781491955987/ch04.html">Kent Beck and Martin Fowler</a>).</p>
<p>The <code>@pytest.fixture</code> decorator provides an easy yet powerful way to setup and teardown resources. You can then pass these defined fixture objects into your test functions as input arguments.</p>
<p>You want each test to be independent, something that you can enforce by <a href="https://twitter.com/tarek_ziade/status/973848758227173376">running your tests in random order</a>.</p>
<p>Fixtures are also referred to as dependency injections which you can read more about <a href="https://en.wikipedia.org/wiki/Dependency_injection">here</a>. Let's look at some actual code next.</p>
<h2>An example - working with databases</h2>
<p>This is a common scenario. In my guest article <a href="https://realpython.com/blog/python/building-a-simple-web-app-with-bottle-sqlalchemy-twitter-api/">Building a Simple Web App With Bottle, SQLAlchemy, and the Twitter API</a> I used a small DB app and pytest for testing. I defined a fixture to make a fresh DB with some test tweets for every test:</p>
<div class="highlight"><pre><span></span><span class="nv">@pytest</span><span class="p">.</span><span class="n">fixture</span><span class="p">()</span><span class="w"></span>
<span class="n">def</span><span class="w"> </span><span class="n">db_setup</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="n">tweets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">_gen_tweets</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="n">import_tweets</span><span class="p">(</span><span class="n">tweets</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">import_hashtags</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">fin</span><span class="p">()</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="n">truncate_tables</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="n">request</span><span class="p">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span><span class="w"></span>
</pre></div>


<p>A couple of things to notice here:</p>
<ul>
<li>
<p>You define a fixture with a function wrapping it into the <code>@pytest.fixture()</code> decorator</p>
</li>
<li>
<p>You probably want some static data to work with, here <code>_gen_tweets</code> loaded in a <em>tweets.json</em> file</p>
</li>
<li>
<p>To define a teardown use the <code>def fin(): ...</code> + <code>request.addfinalizer(fin)</code> construct to do the required cleanup after each test. You can also use <code>yield</code> (see <a href="https://docs.pytest.org/en/latest/fixture.html#fixture-finalization-executing-teardown-code">pytest docs</a>).</p>
</li>
</ul>
<p>Then to use this fixture on the test methods we can just pass it in as function argument:</p>
<div class="highlight"><pre><span></span><span class="n">def</span> <span class="n">test_get_tips</span><span class="p">(</span><span class="n">db_setup</span><span class="p">):</span>
    <span class="p">...</span>


<span class="n">def</span> <span class="n">test_add_tips</span><span class="p">(</span><span class="n">db_setup</span><span class="p">):</span>
    <span class="p">...</span>


<span class="n">def</span> <span class="n">test_get_hashtags</span><span class="p">(</span><span class="n">db_setup</span><span class="p">):</span>
    <span class="p">...</span>


<span class="n">def</span> <span class="n">test_add_hashtags</span><span class="p">(</span><span class="n">db_setup</span><span class="p">):</span>
    <span class="p">...</span>
</pre></div>


<p>You can access this code <a href="https://github.com/pybites/pytip/blob/master/tests/test_tips.py">here</a>.</p>
<h2>Second example - a groceries cart</h2>
<p>I prepared a second example for this article. Here is a <code>Groceries</code> class (final code examples are <a href="https://github.com/pybites/blog_code/tree/master/pytest/fixtures">here</a>). It lets you manage a list of items. Each <code>Item</code> is a <code>namedtuple</code> of product (name), price and a craving <code>bool</code>. The <code>DuplicateProduct</code> and <code>MaxCravingsReached</code> exceptions are used to control the data added and the amount of sugary foods I try to buy ðŸ˜‚</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="n">MAX_CRAVINGS</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">Item</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Item&#39;</span><span class="p">,</span> <span class="s1">&#39;product price craving&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DuplicateProduct</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">MaxCravingsReached</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Groceries</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This cart can be instantiated with a list of namedtuple</span>
<span class="sd">        items, if not provided use an empty list&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="n">items</span> <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print a simple table of cart items with total at the end&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">:</span>
            <span class="n">product</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{item.product}&#39;</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">craving</span><span class="p">:</span>
                <span class="n">product</span> <span class="o">+=</span> <span class="s1">&#39; (craving)&#39;</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{product:&lt;30} | {item.price:&gt;3}&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">36</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{&quot;Total&quot;:&lt;30} | {self.due:&gt;3}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new item to cart, raise exceptions if item already in</span>
<span class="sd">        cart, or when we exceed MAX_CRAVINGS&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">product</span> <span class="o">==</span> <span class="n">new_item</span><span class="o">.</span><span class="n">product</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DuplicateProduct</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{new_item.product} already in items&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_item</span><span class="o">.</span><span class="n">craving</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cravings_reached</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MaxCravingsReached</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{MAX_CRAVINGS} allowed&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete item matching &#39;product&#39;, raises IndexError</span>
<span class="sd">        if no item matches&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">product</span> <span class="o">==</span> <span class="n">product</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{product} not in cart&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Case insensitive &#39;contains&#39; search, this is a</span>
<span class="sd">        generator returning matching Item namedtuples&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">search</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">item</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">due</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate total due value of cart&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">price</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_cravings_reached</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if I have too many cravings in my cart &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">craving</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">MAX_CRAVINGS</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The len of cart&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Making the class iterable (cart = Groceries() -&gt; cart[1] etc)</span>
<span class="sd">        without this dunder I would get &#39;TypeError: &#39;Cart&#39; object does</span>
<span class="sd">        not support indexing&#39; when trying to index it&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</pre></div>


<p>Some non-pytest related things to notice here:</p>
<ul>
<li>
<p>It supports <em>show</em>/<em>add</em>/<em>delete</em>, I left the <em>update</em> method out for now. I did leave the <em>search</em> method in though (to show <code>@pytest.mark.parametrize</code> later)</p>
</li>
<li>
<p>The convenient use of <a href="https://pybit.es/property-decorator.html">properties</a></p>
</li>
<li>
<p>Using __len__ and __getitem__ to make the class <em>iterable</em> (we discussed <em>dunder methods</em> in depth in <a href="https://dbader.org/blog/python-dunder-methods">this guest article</a>). Thanks to this Groceries now supports <em>indexing</em> for example (<em>slicing</em> would work too). So when I later instantiate a <code>cart</code> object from it, I can do <code>cart[0].product</code> instead of <code>cart._items[0].product</code>, etc.</p>
</li>
</ul>
<h2>Initial tests for Groceries</h2>
<p>And here is the initial set of tests I wrote for this class:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">groceries</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Groceries</span><span class="p">,</span> <span class="n">Item</span><span class="p">,</span> <span class="n">DuplicateProduct</span><span class="p">,</span>
                    <span class="n">MaxCravingsReached</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_setup_items</span><span class="p">():</span>
    <span class="n">products</span> <span class="o">=</span> <span class="s1">&#39;celery apples water coffee chicken pizza&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">cravings</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">cravings</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">Item</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_initial_empty_cart</span><span class="p">():</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">Groceries</span><span class="p">()</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="o">.</span><span class="n">due</span> <span class="o">==</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">test_initial_filled_cart</span><span class="p">():</span>
    <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_setup_items</span><span class="p">())</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">Groceries</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">)</span>

    <span class="c1"># thanks to __getitem__ can index the cart</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">product</span> <span class="o">==</span> <span class="s1">&#39;celery&#39;</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">product</span> <span class="o">==</span> <span class="s1">&#39;pizza&#39;</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="mi">4</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="o">.</span><span class="n">due</span> <span class="o">==</span> <span class="mi">22</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">cart</span><span class="o">.</span><span class="n">num_cravings_reached</span>


<span class="k">def</span> <span class="nf">test_add_item</span><span class="p">():</span>
    <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_setup_items</span><span class="p">())</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">Groceries</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">)</span>

    <span class="n">oranges</span> <span class="o">=</span> <span class="n">Item</span><span class="p">(</span><span class="n">product</span><span class="o">=</span><span class="s1">&#39;oranges&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">craving</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">oranges</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">product</span> <span class="o">==</span> <span class="s1">&#39;oranges&#39;</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="o">.</span><span class="n">due</span> <span class="o">==</span> <span class="mi">25</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">cart</span><span class="o">.</span><span class="n">num_cravings_reached</span>


<span class="k">def</span> <span class="nf">test_add_item_duplicate</span><span class="p">():</span>
    <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_setup_items</span><span class="p">())</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">Groceries</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">)</span>

    <span class="n">apples</span> <span class="o">=</span> <span class="n">Item</span><span class="p">(</span><span class="n">product</span><span class="o">=</span><span class="s1">&#39;apples&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">craving</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">DuplicateProduct</span><span class="p">):</span>
        <span class="n">cart</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">apples</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_add_item_max_cravings</span><span class="p">():</span>
    <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_setup_items</span><span class="p">())</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">Groceries</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">)</span>

    <span class="n">chocolate</span> <span class="o">=</span> <span class="n">Item</span><span class="p">(</span><span class="n">product</span><span class="o">=</span><span class="s1">&#39;chocolate&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">craving</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">chocolate</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="o">.</span><span class="n">num_cravings_reached</span>

    <span class="n">croissants</span> <span class="o">=</span> <span class="n">Item</span><span class="p">(</span><span class="n">product</span><span class="o">=</span><span class="s1">&#39;croissants&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">craving</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">MaxCravingsReached</span><span class="p">):</span>
        <span class="n">cart</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">croissants</span><span class="p">)</span>  <span class="c1"># wait till next week!</span>


<span class="k">def</span> <span class="nf">test_delete_item</span><span class="p">():</span>
    <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_setup_items</span><span class="p">())</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">Groceries</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">)</span>

    <span class="c1"># not in collection</span>
    <span class="n">croissant</span> <span class="o">=</span> <span class="s1">&#39;croissant&#39;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">IndexError</span><span class="p">):</span>
        <span class="n">cart</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">croissant</span><span class="p">)</span>

    <span class="c1"># in collection</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span>
    <span class="n">apples</span> <span class="o">=</span> <span class="s1">&#39;apples&#39;</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">apples</span><span class="p">)</span>
    <span class="c1"># new product at this index</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">product</span> <span class="o">==</span> <span class="s1">&#39;water&#39;</span>


<span class="nd">@pytest.mark.parametrize</span><span class="p">(</span><span class="s2">&quot;test_input,expected&quot;</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;banana&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Apples&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;le&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;zZ&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
<span class="p">])</span>
<span class="k">def</span> <span class="nf">test_search_item</span><span class="p">(</span><span class="n">test_input</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
    <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_setup_items</span><span class="p">())</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">Groceries</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cart</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">test_input</span><span class="p">)))</span> <span class="o">==</span> <span class="n">expected</span>


<span class="k">def</span> <span class="nf">test_show_items</span><span class="p">(</span><span class="n">capfd</span><span class="p">):</span>
    <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_setup_items</span><span class="p">())</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">Groceries</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">)</span>

    <span class="n">cart</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">capfd</span><span class="o">.</span><span class="n">readouterr</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

    <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^celery.*1$&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^pizza \(craving\).*4$&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^Total.*22$&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>


<p>Things to notice:</p>
<ul>
<li>
<p>Right off the bat you see that annoying setup repetition in each test: <code>cart = Groceries</code>! We will tackle this shortly.</p>
</li>
<li>
<p>Here are some other nice pytest features I am using a lot lately:</p>
<ul>
<li>
<p>To test an exception (<code>DuplicateProduct</code> and <code>MaxCravingsReached</code> here) you can use this construct:</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pytest</span><span class="p">.</span><span class="n">raises</span><span class="p">(</span><span class="k">Exception</span><span class="p">):</span>
    <span class="n">run</span> <span class="n">code</span> <span class="n">that</span> <span class="n">triggers</span> <span class="n">the</span> <span class="k">Exception</span>
</pre></div>


</li>
<li>
<p><code>@pytest.mark.parametrize</code> to run a test with a different set of <em>input</em> and <em>expected</em> values. This addresses the same need to keep your code slim avoiding duplication.</p>
</li>
<li>
<p>to consume the <em>stdout</em> of your program you can pass in the <em>capfd</em> input parameter to your test function and accessing its <code>readouterr</code> method. I use it in <code>test_show_ output</code> to test the groceries report output. Actually as I was writing this article I discovered that <code>capfd</code> is actually a <em>fixture</em> itself, you can see this when you run <code>pytest --fixtures</code>:</p>
<div class="highlight"><pre><span></span>...
...
<span class="nv">capfd</span>
<span class="nv">Enable</span> <span class="nv">capturing</span> <span class="nv">of</span> <span class="nv">writes</span> <span class="nv">to</span> <span class="nv">file</span> <span class="nv">descriptors</span> <span class="mi">1</span> <span class="nv">and</span> <span class="mi">2</span> <span class="nv">and</span> <span class="nv">make</span>
<span class="nv">captured</span> <span class="nv">output</span> <span class="nv">available</span> <span class="nv">via</span> ``<span class="nv">capfd</span>.<span class="nv">readouterr</span><span class="ss">()</span>`` <span class="nv">method</span> <span class="nv">calls</span>
<span class="nv">which</span> <span class="k">return</span> <span class="nv">a</span> ``<span class="ss">(</span><span class="nv">out</span>, <span class="nv">err</span><span class="ss">)</span>`` <span class="nv">tuple</span>.  ``<span class="nv">out</span>`` <span class="nv">and</span> ``<span class="nv">err</span>`` <span class="nv">will</span> <span class="nv">be</span> ``<span class="nv">text</span>``
<span class="nv">objects</span>.
</pre></div>


</li>
</ul>
</li>
</ul>
<h2>Coverage</h2>
<p>I am making a habit of using <a href="https://pypi.python.org/pypi/pytest-cov">pytest-cov</a> to see my test coverage:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="n">pytest</span><span class="p">)</span><span class="w"> </span><span class="o">[</span><span class="n">bbelderb@macbook fixtures (master)</span><span class="o">]</span><span class="err">$</span><span class="w"> </span><span class="n">pytest</span><span class="w"> </span><span class="c1">--cov-report term-missing --cov=&#39;.&#39;</span>
<span class="o">=============================================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">==============================================</span><span class="w"></span>
<span class="n">platform</span><span class="w"> </span><span class="n">darwin</span><span class="w"> </span><span class="c1">-- Python 3.6.1, pytest-3.4.2, py-1.5.2, pluggy-0.6.0</span>
<span class="nl">rootdir</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">bbelderb</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pybites_code</span><span class="o">/</span><span class="n">pytest</span><span class="o">/</span><span class="n">fixtures</span><span class="p">,</span><span class="w"> </span><span class="nl">inifile</span><span class="p">:</span><span class="w"></span>
<span class="nl">plugins</span><span class="p">:</span><span class="w"> </span><span class="n">cov</span><span class="o">-</span><span class="mf">2.5.1</span><span class="w"></span>
<span class="n">collected</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="n">items</span><span class="w"></span>

<span class="n">test_groceries</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="p">..............</span><span class="w">                                                                         </span><span class="o">[</span><span class="n">100%</span><span class="o">]</span><span class="w"></span>

<span class="c1">---------- coverage: platform darwin, python 3.6.1-final-0 -----------</span>
<span class="n">Name</span><span class="w">                </span><span class="n">Stmts</span><span class="w">   </span><span class="n">Miss</span><span class="w">  </span><span class="n">Cover</span><span class="w">   </span><span class="n">Missing</span><span class="w"></span>
<span class="c1">-------------------------------------------------</span>
<span class="n">groceries</span><span class="p">.</span><span class="n">py</span><span class="w">           </span><span class="mi">42</span><span class="w">      </span><span class="mi">0</span><span class="w">   </span><span class="mi">100</span><span class="o">%</span><span class="w"></span>
<span class="n">test_groceries</span><span class="p">.</span><span class="n">py</span><span class="w">      </span><span class="mi">71</span><span class="w">      </span><span class="mi">0</span><span class="w">   </span><span class="mi">100</span><span class="o">%</span><span class="w"></span>
<span class="c1">-------------------------------------------------</span>
<span class="n">TOTAL</span><span class="w">                 </span><span class="mi">113</span><span class="w">      </span><span class="mi">0</span><span class="w">   </span><span class="mi">100</span><span class="o">%</span><span class="w"></span>


<span class="o">==========================================</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.34</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="o">===========================================</span><span class="w"></span>
</pre></div>


<p>As I run this over and over again I added this alias to my <code>.vimrc</code> so I can run this from my test file pressing <code>,t</code>:</p>
<div class="highlight"><pre><span></span><span class="n">nmap</span> <span class="p">,</span><span class="n">t</span> <span class="p">:</span><span class="n">w</span><span class="o">&lt;</span><span class="n">CR</span><span class="o">&gt;</span><span class="p">:</span><span class="o">!</span><span class="n">pytest</span> <span class="o">-</span><span class="n">s</span> <span class="c1">--cov-report term-missing --cov=&#39;.&#39;&lt;CR&gt;</span>
</pre></div>


<p>(if you don't want to see stdout from your tests drop the <em>-s</em>)</p>
<h2>Let's refactor this using a fixture</h2>
<p>As we saw the setup code of the Groceries gets repeated over and over again. Let's wrap it in a fixture:</p>
<div class="highlight"><pre><span></span>@<span class="nv">pytest</span>.<span class="nv">fixture</span>
<span class="nv">def</span> <span class="nv">cart</span><span class="ss">()</span>:
    <span class="s2">&quot;&quot;&quot;</span><span class="s">Setup code to create a groceries cart object with 6 items in it</span><span class="s2">&quot;&quot;&quot;</span>
    <span class="nv">products</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">celery apples water coffee chicken pizza</span><span class="s1">&#39;</span>.<span class="nv">split</span><span class="ss">()</span>
    <span class="nv">prices</span> <span class="o">=</span> [<span class="mi">1</span>, <span class="mi">4</span>, <span class="mi">2</span>, <span class="mi">5</span>, <span class="mi">6</span>, <span class="mi">4</span>]
    <span class="nv">cravings</span> <span class="o">=</span> <span class="nv">False</span>, <span class="nv">False</span>, <span class="nv">False</span>, <span class="nv">False</span>, <span class="nv">False</span>, <span class="nv">True</span>

    <span class="nv">items</span> <span class="o">=</span> []
    <span class="k">for</span> <span class="nv">item</span> <span class="nv">in</span> <span class="nv">zip</span><span class="ss">(</span><span class="nv">products</span>, <span class="nv">prices</span>, <span class="nv">cravings</span><span class="ss">)</span>:
        <span class="nv">items</span>.<span class="nv">append</span><span class="ss">(</span><span class="nv">Item</span><span class="ss">(</span><span class="o">*</span><span class="nv">item</span><span class="ss">))</span>

    <span class="k">return</span> <span class="nv">Groceries</span><span class="ss">(</span><span class="nv">items</span><span class="ss">)</span>
</pre></div>


<p>To use it I need to add it as input argument to each test function that uses it:</p>
<div class="highlight"><pre><span></span>$ grep ^def test_groceries.py
def cart<span class="o">()</span>:
def test_initial_empty_cart<span class="o">()</span>:
def test_initial_filled_cart<span class="o">(</span>cart<span class="o">)</span>:
def test_add_item<span class="o">(</span>cart<span class="o">)</span>:
def test_add_item_duplicate<span class="o">(</span>cart<span class="o">)</span>:
def test_add_item_max_cravings<span class="o">(</span>cart<span class="o">)</span>:
def test_delete_item<span class="o">(</span>cart<span class="o">)</span>:
def test_search_item<span class="o">(</span>cart, test_input, expected<span class="o">)</span>:
def test_show_items<span class="o">(</span>cart, capfd<span class="o">)</span>:
</pre></div>


<p>Note that:</p>
<ul>
<li>
<p>In the first test I left the <code>Groceries</code> instantiation in because I wanted to create it with an empty <code>items</code> list (you can probably parametrize the fixture but this will do for now).</p>
</li>
<li>
<p>In the tests that use other arguments like <code>@pytest.mark.parametrize</code> and <code>capfd</code> (in <code>test_search_item</code> and <code>test_show_items</code> respectively), the fixture argument comes first!</p>
</li>
</ul>
<p>And now I can ditch these lines of code which were duplicated multiple times:</p>
<div class="highlight"><pre><span></span><span class="n">items</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">_setup_items</span><span class="p">())</span>
<span class="n">cart</span> <span class="o">=</span> <span class="n">Groceries</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">)</span>
</pre></div>


<p>Let's run the tests again:</p>
<div class="highlight"><pre><span></span><span class="ss">(</span><span class="nv">pytest</span><span class="ss">)</span> [<span class="nv">bbelderb</span>@<span class="nv">macbook</span> <span class="nv">fixtures</span> <span class="ss">(</span><span class="nv">master</span><span class="ss">)</span>]$ <span class="nv">pytest</span> <span class="o">--</span><span class="nv">cov</span><span class="o">-</span><span class="nv">report</span> <span class="nv">term</span><span class="o">-</span><span class="nv">missing</span> <span class="o">--</span><span class="nv">cov</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">.</span><span class="s1">&#39;</span>
<span class="o">=============================================</span> <span class="nv">test</span> <span class="nv">session</span> <span class="nv">starts</span> <span class="o">==============================================</span>
<span class="nv">platform</span> <span class="nv">darwin</span> <span class="o">--</span> <span class="nv">Python</span> <span class="mi">3</span>.<span class="mi">6</span>.<span class="mi">1</span>, <span class="nv">pytest</span><span class="o">-</span><span class="mi">3</span>.<span class="mi">4</span>.<span class="mi">2</span>, <span class="nv">py</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">5</span>.<span class="mi">2</span>, <span class="nv">pluggy</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">6</span>.<span class="mi">0</span>
<span class="nv">Using</span> <span class="o">--</span><span class="k">random</span><span class="o">-</span><span class="nv">order</span><span class="o">-</span><span class="nv">bucket</span><span class="o">=</span><span class="nv">module</span>
<span class="nv">Using</span> <span class="o">--</span><span class="k">random</span><span class="o">-</span><span class="nv">order</span><span class="o">-</span><span class="nv">seed</span><span class="o">=</span><span class="mi">270491</span>

<span class="nv">rootdir</span>: <span class="o">/</span><span class="nv">Users</span><span class="o">/</span><span class="nv">bbelderb</span><span class="o">/</span><span class="nv">code</span><span class="o">/</span><span class="nv">pybites_code</span><span class="o">/</span><span class="nv">pytest</span><span class="o">/</span><span class="nv">fixtures</span>, <span class="nv">inifile</span>:
<span class="nv">plugins</span>: <span class="k">random</span><span class="o">-</span><span class="nv">order</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">5</span>.<span class="mi">4</span>, <span class="nv">cov</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">5</span>.<span class="mi">1</span>
<span class="nv">collected</span> <span class="mi">14</span> <span class="nv">items</span>

<span class="nv">test_groceries</span>.<span class="nv">py</span> ..............                                                                         [<span class="mi">100</span><span class="o">%</span>]

<span class="o">----------</span> <span class="nv">coverage</span>: <span class="nv">platform</span> <span class="nv">darwin</span>, <span class="nv">python</span> <span class="mi">3</span>.<span class="mi">6</span>.<span class="mi">1</span><span class="o">-</span><span class="nv">final</span><span class="o">-</span><span class="mi">0</span> <span class="o">-----------</span>
<span class="nv">Name</span>                <span class="nv">Stmts</span>   <span class="nv">Miss</span>  <span class="nv">Cover</span>   <span class="nv">Missing</span>
<span class="o">-------------------------------------------------</span>
<span class="nv">groceries</span>.<span class="nv">py</span>           <span class="mi">42</span>      <span class="mi">0</span>   <span class="mi">100</span><span class="o">%</span>
<span class="nv">test_groceries</span>.<span class="nv">py</span>      <span class="mi">59</span>      <span class="mi">0</span>   <span class="mi">100</span><span class="o">%</span>
<span class="o">-------------------------------------------------</span>
<span class="nv">TOTAL</span>                 <span class="mi">101</span>      <span class="mi">0</span>   <span class="mi">100</span><span class="o">%</span>


<span class="o">==========================================</span> <span class="mi">14</span> <span class="nv">passed</span> <span class="nv">in</span> <span class="mi">0</span>.<span class="mi">14</span> <span class="nv">seconds</span> <span class="o">===========================================</span>
</pre></div>


<p>Nice: 12 lines of test code less!</p>
<p>I only covered the basics so far. However this should get you started using fixtures in your tests. Next I will highlight 2 more features of fixtures.</p>
<h2>Define a scope of a fixture</h2>
<p>How to share your fixture across tests in a class, module or session?</p>
<p>In our example the setup is super fast so it is not really needed. But what if your setup code deals with a lot of data or has a costly network connection dependency? To simulate this let's add a <code>sleep(1)</code> to our <code>cart</code> fixture to see what happens:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="o">...</span>

<span class="nd">@pytest.fixture</span>
<span class="k">def</span> <span class="nf">cart</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Setup code to create a groceries cart object with 6 items in it&quot;&quot;&quot;</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">...</span>

<span class="err">$</span> <span class="n">pytest</span>
<span class="o">...</span>
<span class="mi">14</span> <span class="n">passed</span> <span class="ow">in</span> <span class="mf">13.15</span> <span class="n">seconds</span>
</pre></div>


<p>Oops ... it slept upon each test function! That is because a fixture's scope is set to <em>function</em> by default. To run the fixture once per module add <code>scope="module"</code> to the <code>@pytest.fixture</code> decorator (or <code>scope="session"</code> as we will see later on). Let's compare:</p>
<div class="highlight"><pre><span></span><span class="nv">@pytest</span><span class="p">.</span><span class="n">fixture</span><span class="p">(</span><span class="k">scope</span><span class="o">=</span><span class="ss">&quot;module&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">def</span><span class="w"> </span><span class="n">cart</span><span class="p">()</span><span class="err">:</span><span class="w"></span>
<span class="w">    </span><span class="ss">&quot;&quot;&quot;Setup code to create a groceries cart object with 6 items in it&quot;&quot;&quot;</span><span class="w"></span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>

<span class="err">$</span><span class="w"> </span><span class="n">pytest</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="mi">6</span><span class="w"> </span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">1.21</span><span class="w"> </span><span class="n">seconds</span><span class="w"></span>
<span class="err">$</span><span class="w"> </span><span class="n">pytest</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="mi">3</span><span class="w"> </span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">1.17</span><span class="w"> </span><span class="n">seconds</span><span class="w"></span>
</pre></div>


<p>What happened?! The timing is right, there is a sleep of 1 second, but I introduced random test failures! The tests became tainted because it changed the same mutable <code>cart</code> object in various tests, not resetting it back to its initial state (like it did when scope was <em>function</em>).</p>
<p>So use this with caution. In this case we should just use the default <em>function</em> scope because the setup is very fast (<code>14 passed in 0.14 seconds</code> remember?). But to further demo the <em>scope</em> feature let's make this example work.</p>
<p>In this case I just make a copy of the <code>cart</code> object where I am going to  manipulate it. I am using <code>deepcopy</code> because this is a nested data structure (learn more why you want this <a href="https://pybit.es/mutability.html">here</a>). It was only in 3 places:</p>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">grep</span> <span class="o">-</span><span class="n">B1</span> <span class="n">deepcopy</span> <span class="n">test_groceries</span><span class="o">.</span><span class="n">py</span>
<span class="o">...</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="o">--</span>
<span class="k">def</span> <span class="nf">test_add_item</span><span class="p">(</span><span class="n">cart</span><span class="p">):</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span>  <span class="c1"># not needed if scope &gt; function (module/session)</span>
<span class="o">--</span>
<span class="k">def</span> <span class="nf">test_add_item_max_cravings</span><span class="p">(</span><span class="n">cart</span><span class="p">):</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span>
<span class="o">--</span>
<span class="k">def</span> <span class="nf">test_delete_item</span><span class="p">(</span><span class="n">cart</span><span class="p">):</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span>
</pre></div>


<p>And it works again:</p>
<div class="highlight"><pre><span></span>$ pytest
...
<span class="m">14</span> passed in <span class="m">1</span>.10 seconds
</pre></div>


<h2>Re-use fixtures in various test files</h2>
<p>The second and last feature I want to highlight. You can add fixtures to a predefined file called <code>conftest.py</code>. Fixtures in this file will be automatically discovered upon running pytest, no import needed.</p>
<p>Let's do an experiment: let's move the tests that make changes to the <code>cart</code> object into <code>test_edit_cart.py</code> and the ones that don't into <code>test_view_cart.py</code>. We will need the fixture for both test files so I am moving it into <code>conftest.py</code>. The code looks more modular now:</p>
<p><a href="https://github.com/pybites/blog_code/blob/master/pytest/fixtures/conftest.py">conftest.py</a></p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">groceries</span> <span class="kn">import</span> <span class="n">Groceries</span><span class="p">,</span> <span class="n">Item</span>


<span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cart</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Setup code to create a groceries cart object with 6 items in it&quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;sleeping a bit at session level&#39;</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># for scope=module/session demo purposes</span>
    <span class="n">products</span> <span class="o">=</span> <span class="s1">&#39;celery apples water coffee chicken pizza&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">cravings</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">True</span>

    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">cravings</span><span class="p">):</span>
        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">Groceries</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
</pre></div>


<p><a href="https://github.com/pybites/blog_code/blob/master/pytest/fixtures/test_view_cart.py">test_view_cart.py</a></p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">groceries</span> <span class="kn">import</span> <span class="n">Groceries</span>


<span class="k">def</span> <span class="nf">test_initial_empty_cart</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Note no fixture here to test an empty cart creation&quot;&quot;&quot;</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">Groceries</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="o">.</span><span class="n">due</span> <span class="o">==</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">test_initial_filled_cart</span><span class="p">(</span><span class="n">cart</span><span class="p">):</span>
    <span class="c1"># thanks to __getitem__ can index the cart</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">product</span> <span class="o">==</span> <span class="s1">&#39;celery&#39;</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">product</span> <span class="o">==</span> <span class="s1">&#39;pizza&#39;</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="mi">4</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="o">.</span><span class="n">due</span> <span class="o">==</span> <span class="mi">22</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">cart</span><span class="o">.</span><span class="n">num_cravings_reached</span>


<span class="nd">@pytest.mark.parametrize</span><span class="p">(</span><span class="s2">&quot;test_input,expected&quot;</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;banana&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Apples&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;le&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;zZ&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
<span class="p">])</span>
<span class="k">def</span> <span class="nf">test_search_item</span><span class="p">(</span><span class="n">cart</span><span class="p">,</span> <span class="n">test_input</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cart</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">test_input</span><span class="p">)))</span> <span class="o">==</span> <span class="n">expected</span>


<span class="k">def</span> <span class="nf">test_show_items</span><span class="p">(</span><span class="n">cart</span><span class="p">,</span> <span class="n">capfd</span><span class="p">):</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">capfd</span><span class="o">.</span><span class="n">readouterr</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

    <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^celery.*1$&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^pizza \(craving\).*4$&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^Total.*22$&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>


<p><a href="https://github.com/pybites/blog_code/blob/master/pytest/fixtures/test_edit_cart.py">test_edit_cart.py</a></p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">groceries</span> <span class="kn">import</span> <span class="n">Item</span><span class="p">,</span> <span class="n">DuplicateProduct</span><span class="p">,</span> <span class="n">MaxCravingsReached</span>


<span class="k">def</span> <span class="nf">test_add_item</span><span class="p">(</span><span class="n">cart</span><span class="p">):</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span>  <span class="c1"># not needed if scope=function</span>

    <span class="n">oranges</span> <span class="o">=</span> <span class="n">Item</span><span class="p">(</span><span class="n">product</span><span class="o">=</span><span class="s1">&#39;oranges&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">craving</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">oranges</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">product</span> <span class="o">==</span> <span class="s1">&#39;oranges&#39;</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="o">.</span><span class="n">due</span> <span class="o">==</span> <span class="mi">25</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">cart</span><span class="o">.</span><span class="n">num_cravings_reached</span>


<span class="k">def</span> <span class="nf">test_add_item_max_cravings</span><span class="p">(</span><span class="n">cart</span><span class="p">):</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span>
    <span class="n">chocolate</span> <span class="o">=</span> <span class="n">Item</span><span class="p">(</span><span class="n">product</span><span class="o">=</span><span class="s1">&#39;chocolate&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">craving</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">chocolate</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="o">.</span><span class="n">num_cravings_reached</span>

    <span class="n">croissants</span> <span class="o">=</span> <span class="n">Item</span><span class="p">(</span><span class="n">product</span><span class="o">=</span><span class="s1">&#39;croissants&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">craving</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">MaxCravingsReached</span><span class="p">):</span>
        <span class="n">cart</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">croissants</span><span class="p">)</span>  <span class="c1"># wait till next week!</span>


<span class="k">def</span> <span class="nf">test_add_item_duplicate</span><span class="p">(</span><span class="n">cart</span><span class="p">):</span>
    <span class="n">apples</span> <span class="o">=</span> <span class="n">Item</span><span class="p">(</span><span class="n">product</span><span class="o">=</span><span class="s1">&#39;apples&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">craving</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">DuplicateProduct</span><span class="p">):</span>
        <span class="n">cart</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">apples</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_delete_item</span><span class="p">(</span><span class="n">cart</span><span class="p">):</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span>
    <span class="c1"># not in collection</span>
    <span class="n">croissant</span> <span class="o">=</span> <span class="s1">&#39;croissant&#39;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">IndexError</span><span class="p">):</span>
        <span class="n">cart</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">croissant</span><span class="p">)</span>

    <span class="c1"># in collection</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span>
    <span class="n">apples</span> <span class="o">=</span> <span class="s1">&#39;apples&#39;</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">apples</span><span class="p">)</span>
    <span class="c1"># new product at this index</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">product</span> <span class="o">==</span> <span class="s1">&#39;water&#39;</span>
</pre></div>


<p>And let's run the tests again:</p>
<div class="highlight"><pre><span></span>$ <span class="nv">pytest</span>
<span class="o">================================================</span> <span class="nv">test</span> <span class="nv">session</span> <span class="nv">starts</span> <span class="o">================================================</span>
<span class="nv">platform</span> <span class="nv">darwin</span> <span class="o">--</span> <span class="nv">Python</span> <span class="mi">3</span>.<span class="mi">6</span>.<span class="mi">1</span>, <span class="nv">pytest</span><span class="o">-</span><span class="mi">3</span>.<span class="mi">4</span>.<span class="mi">2</span>, <span class="nv">py</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">5</span>.<span class="mi">2</span>, <span class="nv">pluggy</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">6</span>.<span class="mi">0</span>
<span class="nv">Using</span> <span class="o">--</span><span class="k">random</span><span class="o">-</span><span class="nv">order</span><span class="o">-</span><span class="nv">bucket</span><span class="o">=</span><span class="nv">module</span>
<span class="nv">Using</span> <span class="o">--</span><span class="k">random</span><span class="o">-</span><span class="nv">order</span><span class="o">-</span><span class="nv">seed</span><span class="o">=</span><span class="mi">885306</span>

<span class="nv">rootdir</span>: <span class="o">/</span><span class="nv">Users</span><span class="o">/</span><span class="nv">bbelderb</span><span class="o">/</span><span class="nv">code</span><span class="o">/</span><span class="nv">pybites_code</span><span class="o">/</span><span class="nv">pytest</span><span class="o">/</span><span class="nv">fixtures</span>, <span class="nv">inifile</span>:
<span class="nv">plugins</span>: <span class="k">random</span><span class="o">-</span><span class="nv">order</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">5</span>.<span class="mi">4</span>, <span class="nv">cov</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">5</span>.<span class="mi">1</span>
<span class="nv">collected</span> <span class="mi">14</span> <span class="nv">items</span>

<span class="nv">test_edit_cart</span>.<span class="nv">py</span> ...                                                                                         [ <span class="mi">21</span><span class="o">%</span>]
<span class="nv">test_view_cart</span>.<span class="nv">py</span> ...........                                                                                 [<span class="mi">100</span><span class="o">%</span>]

<span class="o">=============================================</span> <span class="mi">14</span> <span class="nv">passed</span> <span class="nv">in</span> <span class="mi">2</span>.<span class="mi">12</span> <span class="nv">seconds</span> <span class="o">=============================================</span>
</pre></div>


<p>Again note that I did not have to import <code>conftest.py</code>, nice!</p>
<p>But wait, the <code>sleep</code> ran twice this time, because the scope was still defined as <em>module</em> (meaning <em>file</em>). Let's change it to <em>session</em> and check again:</p>
<div class="highlight"><pre><span></span>@<span class="nv">pytest</span>.<span class="nv">fixture</span><span class="ss">(</span><span class="nv">scope</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">session</span><span class="s2">&quot;</span><span class="ss">)</span>
<span class="nv">def</span> <span class="nv">cart</span><span class="ss">()</span>:
    <span class="s2">&quot;&quot;&quot;</span><span class="s">Setup code to create a groceries cart object with 6 items in it</span><span class="s2">&quot;&quot;&quot;</span>
    <span class="nv">print</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">sleeping a bit at session level</span><span class="s1">&#39;</span><span class="ss">)</span>
    <span class="nv">sleep</span><span class="ss">(</span><span class="mi">1</span><span class="ss">)</span>  # <span class="k">for</span> <span class="nv">scope</span><span class="o">=</span><span class="nv">module</span><span class="o">/</span><span class="nv">session</span> <span class="nv">demo</span> <span class="nv">purposes</span>
</pre></div>


<p>Running the tests now gives:</p>
<div class="highlight"><pre><span></span><span class="ss">(</span><span class="nv">pytest</span><span class="ss">)</span> [<span class="nv">bbelderb</span>@<span class="nv">macbook</span> <span class="nv">fixtures</span> <span class="ss">(</span><span class="nv">master</span><span class="ss">)</span>]$ <span class="nv">pytest</span>
<span class="o">================================================</span> <span class="nv">test</span> <span class="nv">session</span> <span class="nv">starts</span> <span class="o">================================================</span>
<span class="nv">platform</span> <span class="nv">darwin</span> <span class="o">--</span> <span class="nv">Python</span> <span class="mi">3</span>.<span class="mi">6</span>.<span class="mi">1</span>, <span class="nv">pytest</span><span class="o">-</span><span class="mi">3</span>.<span class="mi">4</span>.<span class="mi">2</span>, <span class="nv">py</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">5</span>.<span class="mi">2</span>, <span class="nv">pluggy</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">6</span>.<span class="mi">0</span>
<span class="nv">Using</span> <span class="o">--</span><span class="k">random</span><span class="o">-</span><span class="nv">order</span><span class="o">-</span><span class="nv">bucket</span><span class="o">=</span><span class="nv">module</span>
<span class="nv">Using</span> <span class="o">--</span><span class="k">random</span><span class="o">-</span><span class="nv">order</span><span class="o">-</span><span class="nv">seed</span><span class="o">=</span><span class="mi">578283</span>

<span class="nv">rootdir</span>: <span class="o">/</span><span class="nv">Users</span><span class="o">/</span><span class="nv">bbelderb</span><span class="o">/</span><span class="nv">code</span><span class="o">/</span><span class="nv">pybites_code</span><span class="o">/</span><span class="nv">pytest</span><span class="o">/</span><span class="nv">fixtures</span>, <span class="nv">inifile</span>:
<span class="nv">plugins</span>: <span class="k">random</span><span class="o">-</span><span class="nv">order</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">5</span>.<span class="mi">4</span>, <span class="nv">cov</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">5</span>.<span class="mi">1</span>
<span class="nv">collected</span> <span class="mi">14</span> <span class="nv">items</span>

<span class="nv">test_view_cart</span>.<span class="nv">py</span> ...........                                                                                 [ <span class="mi">78</span><span class="o">%</span>]
<span class="nv">test_edit_cart</span>.<span class="nv">py</span> ...                                                                                         [<span class="mi">100</span><span class="o">%</span>]

<span class="o">=============================================</span> <span class="mi">14</span> <span class="nv">passed</span> <span class="nv">in</span> <span class="mi">1</span>.<span class="mi">13</span> <span class="nv">seconds</span> <span class="o">=============================================</span>
</pre></div>


<p>Awesome!</p>
<h2>List all fixtures</h2>
<p>Lastly I recommend adding docstrings to your fixtures so that they show up when somebody probes for them with the <code>--fixtures</code> flag:</p>
<div class="highlight"><pre><span></span>$ pytest --fixtures test_groceries.py
...
pytest<span class="s1">&#39;s fixtures</span>
<span class="s1">...</span>
<span class="s1">...</span>
<span class="s1">pytest_cov&#39;</span>s fixtures
...
--------------------------------------- fixtures defined from test_groceries ----------------------------------------
cart
    Setup code to create a groceries cart object with <span class="m">6</span> items in it
</pre></div>


<h2>Resources</h2>
<p>This should give you all you need to start using fixtures in your pytest code. You will save time, be more content and most importantly produce more robust test code!</p>
<p>There is more to fixtures though, checkout the well written <a href="https://docs.pytest.org/en/latest/fixture.html">pytest docs</a>. Also <a href="https://pybit.es/pytest-book.html">Brian Okken's book</a> covers them extensively.</p>
<p>Let us know in the comments below if you came up with interesting use cases or you hit a wall?</p>
<p>You will see fixtures increasingly used in our <a href="http://codechalleng.es">Bites of Py</a> test code and I am happy we covered it here now, because it is one of the things that makes pytest great!</p>
<hr>
<p>Keep Calm and Code in Python!</p>
<p>-- Bob</p>


<div id="pbproducts">
  <h3>PyBites Python Tips</h3>
  <div>
    <p>Do you want to get <strong>250+ concise and applicable Python tips</strong> in an ebook that will cost you less than 10 bucks (future updates included), check it out <a href="https://gumroad.com/l/pbtips" target="_blank">here</a>.</p>
    <p>
      <a href="https://gumroad.com/l/pbtips" target="_blank">
        <img src="https://codechalleng.es/static/img/tips-book-thumb.07692e3ba331.png" alt="Get our Python Tips Book">
      </a>
    </p>

    <div id="testimonials">
      <p><i>"The discussions are succinct yet thorough enough to give you a solid grasp of the particular problem. I just wish I would have had this book when I started learning Python." - Daniel H </i></p>
      <p><i>"Bob and Julian are the masters at aggregating these small snippets of code that can really make certain aspects of coding easier." - Jesse B </i></p>
      <p><i>"This is now my favourite first Python go-to reference." - Anthony L </i></p>
      <p><i>"Do you ever go on one of those cooking websites for a recipe and have to scroll for what feels like an eternity to get to the ingredients and the 4 steps the recipe actually takes? This is the opposite of that." - Sergio S </i></p>
      <p class="buttonWrapper">
        <a class="button" href="https://gumroad.com/l/pbtips" target="_blank">
          Get the book
        </a>
      </p>
    </div>
  </div>
</div>    <div class="comments">
        <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'http-pybit-es';
                var disqus_identifier = 'pytest-fixtures.html';
                var disqus_url = 'https://pybit.es/pytest-fixtures.html';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
        <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>
        
    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Sitemap</div>
                        <ul class="list-unstyled">
                            <li><a href="https://pybit.es/pages/guests.html">Authors</a></li>
                            <li><a href="https://pybit.es/pages/community.html">Community</a></li>
                            <li><a href="https://pybit.es/100days">#100DaysOfCode</a></li>
                            <li><a href="https://pybit.es/pages/search.html">Search</a></li>
                            <li><a href="https://pybit.es/pages/privacy-policy.html">Privacy Policy</a></li>
                              <li><a href="https://pybit.es/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">Atom Feed</a></li>
                              <li><a href="https://pybit.es/feeds/all.rss.xml" type="application/rss+xml" rel="alternate">RSS Feed</a></li>
                            <li><a href="mailto:support@pybit.es" title="Contact us by email">Contact Us</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Reach Out</div>
                        <ul class="list-unstyled">
                            <li><a href="mailto:support@pybit.es" target="_blank">Email</a></li>
                            <li><a href="https://twitter.com/pybites" target="_blank">Twitter</a></li>
                            <li><a href="https://facebook.com/pybites" target="_blank">Facebook</a></li>
                            <li><a href="https://github.com/pybites" target="_blank">Github</a></li>
                            <li><a href="https://github.com/PyBites-Open-Source" target="_blank">Open Source</a></li>
                            <li><a href="https://www.youtube.com/channel/UCBn-uKDGsRBfcB0lQeOB_gA" target="_blank">YouTube</a></li>
                        </ul>
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="https://github.com/molivier" target="_blank">molivier</a></em></small><br/>
                            <small>&copy; PyBites 2016+</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->

        <script async>(function(s,u,m,o,j,v){j=u.createElement(m);v=u.getElementsByTagName(m)[0];j.async=1;j.src=o;j.dataset.sumoSiteId='1fa29bd7f87bf829d31c62b2931da29843318b783911e01ffb613bad703fbd88';v.parentNode.insertBefore(j,v)})(window,document,'script','//load.sumo.com/');</script>

    </body>
</html>